<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Canlı Sohbet Odası</title>
    <style>
        :root {
            --primary: #5f27cd;
            --primary-dark: #4a1eaf;
            --bg-gradient: linear-gradient(135deg, #667eea, #764ba2);
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-gradient);
            margin: 0; padding: 20px; min-height: 100vh;
            display: flex; justify-content: center; align-items: flex-start;
        }

        .container {
            width: 100%;
            max-width: 900px; /* masaüstünde geniş görünmesi için */
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 60vh;
            position: relative;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 12px 14px;
            text-align: center;
            font-size: 20px;
            display:flex;
            align-items:center;
            gap:10px;
            justify-content: center;
        }

        .radio-bar {
            display:flex;
            gap:8px;
            align-items:center;
            padding:10px 14px;
            border-bottom:1px solid #eee;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.01));
            flex-wrap:wrap;
        }
        .radio-bar select {
            flex: 1;
            padding:6px 8px;
            border-radius:8px;
            border:1px solid #ddd;
            min-width:150px;
        }
        .radio-bar button { padding:8px 12px; border-radius:8px; border:none; background:var(--primary); color:#fff; cursor:pointer; }
        .radio-status { font-size:12px; color:#666; margin-left:6px; min-width:110px; }

        #messages {
            padding: 15px;
            background: #f8f9fa;
            overflow-y: auto;
            flex:1;
            min-height:0;
        }
        .message {
            margin: 8px 0;
            padding: 10px 14px;
            border-radius: 20px;
            max-width: 85%;
            word-break: break-word;
            position: relative;
            animation: fadeIn 0.28s;
        }
        .you { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 6px; }
        .other { background: #e0e0e0; color: #333; margin-right: auto; border-bottom-left-radius: 6px; }
        .message small { opacity: 0.8; font-size: 11px; display: block; margin-top: 6px; }

        .input-area {
            display: flex;
            padding: 10px;
            background: #fff;
            border-top: 1px solid #eee;
            gap: 8px;
            align-items:center;
            flex-wrap:wrap;
        }
        #name { width: 140px; padding: 10px 12px; border:1px solid #ddd; border-radius: 24px; outline:none; min-width:110px; }
        #msg { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 30px; outline: none; min-width:0; }
        button { padding: 8px 14px; background: var(--primary); color: white; border: none; border-radius: 30px; cursor: pointer; }
        button:hover { background: var(--primary-dark); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

        @media (max-width: 480px) {
            body { padding: 12px; }
            .container { max-width: 100%; border-radius: 14px; }
            .header { font-size: 18px; padding: 10px; }
            .radio-bar { padding:8px; gap:6px; flex-direction:column; align-items:stretch; }
            #name { width: 100%; order:1; }
            .input-area { gap:6px; flex-wrap:wrap; padding:8px; }
            #msg { order:3; width:100%; }
            .input-area button:last-child { order:4; width:100%; border-radius: 12px; padding:10px; }
            .message { font-size: 15px; }
        }

        .radio-embed { width: 100%; display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:10px 14px; border-top:1px solid #eee; }
        .radio-embed iframe { border:0; width:345px; height:65px; max-width:100%; }
        .radio-embed .audio-wrap { width:100%; max-width:640px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">Canlı Sohbet Odası</div>

        <!-- Radyo çalar alanı: Kalp FM varsayılan seçili olacak -->
        <div class="radio-bar" aria-hidden="false">
            <select id="stationSelect">
                <option value="audio:https://yayin.kalpfm.com:8080/stream">Kalp FM (varsayılan)</option>
                <option value="iframe:radyod">Radyod (iframe embed)</option>
            </select>

            <button id="toggleBtn" onclick="toggleRadio()">Çal / Duraklat</button>
            <div class="radio-status" id="radioStatus">Yükleniyor...</div>
        </div>

        <!-- Radyo gömme / oynatma alanı -->
        <div class="radio-embed" id="radioEmbed" aria-hidden="true" style="display:none;">
            <div id="iframeHolder" style="display:none;">
                <iframe id="radyodIframe" src="https://www.radyod.com/iframe-small" width="345" height="65" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            <div class="audio-wrap" id="audioHolder" style="display:none;">
                <audio id="radioPlayer" controls style="width:100%;" crossorigin="anonymous">
                    Tarayıcınız bu ses oynatıcıyı desteklemiyor.
                </audio>
            </div>
        </div>

        <div id="messages" aria-live="polite"></div>

        <div class="input-area">
            <input type="text" id="name" placeholder="Adın" value="">
            <input type="text" id="msg" placeholder="Mesaj yaz...">
            <button onclick="send()">Gönder</button>
        </div>

        <audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-remove-2578.mp3" preload="auto"></audio>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://rtaqxsecuvsncnoovare.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0YXF4c2VjdXZzbmNub292YXJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODcyODcsImV4cCI6MjA4MDI2MzI4N30.18BaKDnEyj97fS5Xl5ZeZsHSwQh6AexkEmMR5QgwUgw'
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        const messagesDiv = document.getElementById('messages')
        const msgInput = document.getElementById('msg')
        const nameInput = document.getElementById('name')
        const sound = document.getElementById('notifySound')

        nameInput.value = localStorage.getItem('chatName') || ''

        // --- Supabase realtime + eski mesajları yükle ---
        try {
            supabase.channel('messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                    addMessage(payload.new.username, payload.new.message, payload.new.created_at, true)
                    if (payload.new.username !== (nameInput.value || 'Misafir')) sound.play()
                })
                .subscribe()
        } catch (e) {
            console.warn('Realtime bağlanamadı:', e)
        }

        async function loadMessages() {
            try {
                const { data } = await supabase.from('messages').select().order('created_at', { ascending: true })
                if (data) data.forEach(m => addMessage(m.username, m.message, m.created_at, false))
            } catch (e) {
                console.warn('Mesajlar yüklenemedi:', e)
            }
        }

        function addMessage(username, text, time, playSound = false) {
            const timeStr = time ? new Date(time).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})
            const isYou = username === (nameInput.value || 'Misafir')
            const div = document.createElement('div')
            div.className = `message ${isYou ? 'you' : 'other'}`
            div.innerHTML = `<strong>${escapeHtml(username)}</strong><br>${escapeHtml(text).replace(/\n/g, '<br>')}<small>${timeStr}</small>`
            messagesDiv.appendChild(div)
            messagesDiv.scrollTop = messagesDiv.scrollHeight
            if (playSound && !isYou) sound.play()
        }

        function escapeHtml(str){
            return String(str)
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'","&#039;");
        }

        window.send = async () => {
            let text = msgInput.value.trim()
            if (!text) return
            let username = nameInput.value.trim() || 'Misafir'
            localStorage.setItem('chatName', username)

            try {
                await supabase.from('messages').insert({ username, message: text })
            } catch (e) {
                console.warn('Mesaj gönderilemedi, yerelde gösteriliyor.', e)
                addMessage(username, text, new Date().toISOString(), false)
            }
            msgInput.value = ''
        }

        msgInput.addEventListener('keypress', e => { if (e.key === 'Enter') send() })
        loadMessages()

        // -------- Radyo mantığı (Kalp FM varsayılan) --------
        const stationSelect = document.getElementById('stationSelect')
        const radioStatus = document.getElementById('radioStatus')
        const radioEmbed = document.getElementById('radioEmbed')
        const iframeHolder = document.getElementById('iframeHolder')
        const audioHolder = document.getElementById('audioHolder')
        const radioPlayer = document.getElementById('radioPlayer')

        function applyStation(){
            const val = stationSelect.value || ''
            if (!val) {
                radioEmbed.style.display = 'none'
                iframeHolder.style.display = 'none'
                audioHolder.style.display = 'none'
                radioPlayer.pause()
                radioPlayer.removeAttribute('src')
                radioStatus.textContent = 'Duruyor'
                return
            }

            if (val === 'iframe:radyod') {
                radioEmbed.style.display = 'flex'
                iframeHolder.style.display = 'block'
                audioHolder.style.display = 'none'
                radioStatus.textContent = 'Iframe yüklendi'
                return
            }

            if (val.startsWith('audio:')) {
                const url = val.replace('audio:','')
                radioEmbed.style.display = 'flex'
                iframeHolder.style.display = 'none'
                audioHolder.style.display = 'block'
                // temizle önceki kaynaklar
                radioPlayer.pause()
                while (radioPlayer.firstChild) radioPlayer.removeChild(radioPlayer.firstChild)
                const srcEl = document.createElement('source')
                srcEl.src = url
                srcEl.type = 'audio/mpeg'
                radioPlayer.appendChild(srcEl)
                radioPlayer.load()
                radioPlayer.play().then(()=> {
                    radioStatus.textContent = 'Çalıyor'
                }).catch(err=>{
                    console.warn('Radyo oynatma hatası:', err)
                    radioStatus.textContent = 'Çalma engellendi — butona basın'
                })
                return
            }
        }

        function toggleRadio(){
            if (audioHolder.style.display === 'block') {
                if (radioPlayer.paused) {
                    radioPlayer.play().then(()=> radioStatus.textContent = 'Çalıyor').catch(()=> radioStatus.textContent = 'Çalma engellendi')
                } else {
                    radioPlayer.pause()
                    radioStatus.textContent = 'Durdu'
                }
                return
            }
            if (iframeHolder.style.display === 'block') {
                iframeHolder.style.display = 'none'
                radioStatus.textContent = 'Durdu'
                return
            }
            applyStation()
        }

        // sayfa yüklendiğinde Kalp FM'i yükle ve çalmayı dene
        window.addEventListener('load', () => {
            // Kalp FM default olarak select'te ilk seçenek, yine de set edip apply ediyoruz
            stationSelect.value = 'audio:https://yayin.kalpfm.com:8080/stream'
            applyStation()
        })
    </script>
</body>
</html>
