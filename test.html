<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CanlÄ± Sohbet OdasÄ±</title>
    <style>
        :root {
            --primary: #5f27cd;
            --primary-dark: #4a1eaf;
            --bg-gradient: linear-gradient(135deg, #667eea, #764ba2);
        }
        /* 5 tema */
        body.theme-pink { --primary: #e91e63; --primary-dark: #c2185b; --bg-gradient: linear-gradient(135deg, #ff9a9e, #fad0c4); }
        body.theme-green { --primary: #00c853; --primary-dark: #00b248; --bg-gradient: linear-gradient(135deg, #a8e6cf, #dcedc1); }
        body.theme-blue { --primary: #1e88e5; --primary-dark: #1565c0; --bg-gradient: linear-gradient(135deg, #84fab0, #8fd3f4); }
        body.theme-orange { --primary: #ff9800; --primary-dark: #f57c00; --bg-gradient: linear-gradient(135deg, #ffe259, #ffa751); }
        body.theme-dark { --primary: #212121; --primary-dark: #000000; --bg-gradient: linear-gradient(135deg, #232526, #414345); }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: var(--bg-gradient);
            margin: 0; padding: 20px; min-height: 100vh;
            display: flex; justify-content: center; align-items: flex-start;
        }

        .container {
            width: 100%; max-width: 420px; background: white; border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); overflow: hidden;
            display: flex; flex-direction: column; min-height: 60vh; position: relative;
        }

        .header {
            background: var(--primary); color: white; padding: 12px 14px; text-align: center;
            font-size: 20px; position: relative; display:flex; align-items:center; gap:10px;
            justify-content: center;
        }

        .theme-selector {
            position: absolute; right: 10px; top: 8px;
        }
        .theme-selector select {
            background: rgba(255,255,255,0.18); color: white; border: none; border-radius: 8px; padding: 4px 8px;
            font-size: 13px;
        }

        /* Radyo Ã§alar alanÄ± (header altÄ±) */
        .radio-bar {
            display:flex; gap:8px; align-items:center; padding:10px 14px; border-bottom:1px solid #eee;
            background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.01));
        }
        .radio-bar select { flex:1; padding:6px 8px; border-radius:8px; border:1px solid #ddd; }
        .radio-bar button { padding:8px 12px; border-radius:8px; border:none; background:var(--primary); color:#fff; cursor:pointer; }
        .radio-status { font-size:12px; color:#666; margin-left:6px; }

        /* Mesaj alanÄ± */
        #messages {
            padding: 15px; background: #f8f9fa; overflow-y: auto;
            flex:1; min-height:0; /* allow flex child to shrink on mobile */
        }
        .message {
            margin: 8px 0; padding: 10px 14px;
            border-radius: 20px; max-width: 85%; word-break: break-word;
            position: relative; animation: fadeIn 0.28s;
        }
        .you { background: var(--primary); color: white; margin-left: auto; border-bottom-right-radius: 6px; }
        .other { background: #e0e0e0; color: #333; margin-right: auto; border-bottom-left-radius: 6px; }
        .message small { opacity: 0.8; font-size: 11px; display: block; margin-top: 6px; }

        /* Girdi alanÄ± */
        .input-area {
            display: flex; padding: 10px; background: #fff; border-top: 1px solid #eee; gap: 8px; align-items:center;
        }
        #name { width: 110px; padding: 10px 12px; border:1px solid #ddd; border-radius: 24px; outline:none; }
        #msg { flex: 1; padding: 10px 14px; border: 1px solid #ddd; border-radius: 30px; outline: none; min-width:0; }
        button { padding: 8px 14px; background: var(--primary); color: white; border: none; border-radius: 30px; cursor: pointer; }
        button:hover { background: var(--primary-dark); }
        .emoji-btn { font-size: 20px; cursor: pointer; background: none; border: none; }
        .emoji-picker { display: none; background: white; border: 1px solid #ddd; border-radius: 12px; padding: 10px; max-width: 320px; flex-wrap: wrap; gap: 6px; position: absolute; bottom: 70px; left: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 50; }
        .emoji-picker.show { display: flex; }
        .emoji-picker span { font-size: 22px; cursor: pointer; }
        .emoji-picker span:hover { transform: scale(1.2); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: none; } }

        /* Responsive - kÃ¼Ã§Ã¼k ekranlarda */
        @media (max-width: 480px) {
            body { padding: 12px; }
            .container { max-width: 100%; border-radius: 14px; }
            .header { font-size: 18px; padding: 10px; }
            .theme-selector { right: 8px; top: 6px; }
            .radio-bar { padding:8px; gap:6px; flex-direction:column; align-items:stretch; }
            #name { width: 100%; order:1; }
            .input-area { gap:6px; flex-wrap:wrap; padding:8px; }
            .emoji-btn { order:2; }
            #msg { order:3; width:100%; }
            .input-area button:last-child { order:4; width:100%; border-radius: 12px; padding:10px; }
            .emoji-picker { left: 8px; bottom: 96px; max-width: 92%; }
            .message { font-size: 15px; }
        }

        .status { font-size: 13px; color: #4caf50; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            CanlÄ± Sohbet OdasÄ±
            <div class="theme-selector">
                <select onchange="changeTheme(this.value)">
                    <option value="default">VarsayÄ±lan</option>
                    <option value="pink">Pembe</option>
                    <option value="green">YeÅŸil</option>
                    <option value="blue">Mavi</option>
                    <option value="orange">Turuncu</option>
                    <option value="dark">Koyu</option>
                </select>
            </div>
        </div>

        <!-- Radyo Ã§alar -->
        <div class="radio-bar" aria-hidden="false">
            <select id="stationSelect" onchange="changeStation(this.value)">
                <!-- Ã¶rnekler; kendi stream URL'niz varsa onu koyun -->
                <option value="">Radyo seÃ§in veya URL yapÄ±ÅŸtÄ±rÄ±n</option>
                <option value="https://stream.live.vc.bbcmedia.co.uk/bbc_radio_fourfm">BBC Radio 4 (Ã¶rnek)</option>
                <option value="https://icecast.radioparadise.com/rock-128">Radio Paradise - Rock (Ã¶rnek)</option>
                <option value="https://icecast.radioparadise.com/mp3-128">Radio Paradise - MP3</option>
            </select>
            <button onclick="toggleRadio()">Ã‡al / Duraklat</button>
            <div class="radio-status" id="radioStatus">Duruyor</div>
        </div>

        <div id="messages" aria-live="polite"></div>

        <div class="input-area">
            <input type="text" id="name" placeholder="AdÄ±n" value="">
            <button class="emoji-btn" onclick="toggleEmoji()">ðŸ˜Š</button>
            <input type="text" id="msg" placeholder="Mesaj yaz...">
            <button onclick="send()">GÃ¶nder</button>
        </div>

        <div class="emoji-picker" id="emojiPicker" aria-hidden="true"></div>

        <audio id="notifySound" src="https://assets.mixkit.co/sfx/preview/mixkit-software-interface-remove-2578.mp3" preload="auto"></audio>
        <!-- Radyo player (gÃ¶rÃ¼nmez) -->
        <audio id="radioPlayer" crossorigin="anonymous"></audio>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

        const SUPABASE_URL = 'https://rtaqxsecuvsncnoovare.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ0YXF4c2VjdXZzbmNub292YXJlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ2ODcyODcsImV4cCI6MjA4MDI2MzI4N30.18BaKDnEyj97fS5Xl5ZeZsHSwQh6AexkEmMR5QgwUgw' // istersen bÄ±rak, zaten Ã¶nceden olanÄ± deÄŸiÅŸtirebilirsin
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        const messagesDiv = document.getElementById('messages')
        const msgInput = document.getElementById('msg')
        const nameInput = document.getElementById('name')
        const emojiPicker = document.getElementById('emojiPicker')
        const sound = document.getElementById('notifySound')

        // AdÄ± hatÄ±rla
        nameInput.value = localStorage.getItem('chatName') || ''

        // Emoji listesi
        const emojis = "ðŸ˜€ ðŸ˜ƒ ðŸ˜„ ðŸ˜ ðŸ˜† ðŸ˜… ðŸ˜‚ ðŸ¤£ ðŸ˜Š ðŸ˜‡ ðŸ™‚ ðŸ™ƒ ðŸ˜‰ ðŸ˜Œ ðŸ˜ ðŸ¥° ðŸ˜˜ ðŸ˜— ðŸ˜™ ðŸ˜š ðŸ˜‹ ðŸ˜› ðŸ˜ ðŸ˜œ ðŸ¤ª ðŸ˜Ž ðŸ¤“ ðŸ§ ðŸ¤¨ ðŸ¤© ðŸ¥³ ðŸ˜ ðŸ˜’ ðŸ˜ž ðŸ˜” ðŸ˜Ÿ ðŸ˜• ðŸ™ ðŸ˜£ ðŸ˜– ðŸ˜« ðŸ˜¤ ðŸ˜  ðŸ˜¡ ðŸ¤¬ ðŸ˜­ ðŸ˜¢ ðŸ˜© ðŸ˜° ðŸ˜¨ ðŸ˜± ðŸ˜³ ðŸ˜µ ðŸ˜² ðŸ¤¯ ðŸ¤” ðŸ¤­ ðŸ¤« ðŸ¤¥ ðŸ˜¶ ðŸ˜ ðŸ˜‘ ðŸ˜¬ ðŸ™„ ðŸ˜¯ ðŸ˜¦ ðŸ˜§ ðŸ˜® ðŸ˜´ ðŸ¤¤ ðŸ˜ª ðŸ˜µâ€ðŸ’« ðŸ¤¢ ðŸ¤® ðŸ¤§ ðŸ¤’ ðŸ¤• ðŸ¥´ ðŸ¤‘ ðŸ¤  ðŸ˜¸ ðŸ˜¹ ðŸ˜º ðŸ˜» ðŸ˜¼ ðŸ˜½ ðŸ™€ ðŸ˜¿ ðŸ˜¾"
        emojis.split(' ').forEach(e => {
            const span = document.createElement('span')
            span.textContent = e
            span.onclick = () => { msgInput.value += e; msgInput.focus() }
            emojiPicker.appendChild(span)
        })

        function toggleEmoji() {
            const showing = emojiPicker.classList.toggle('show')
            emojiPicker.setAttribute('aria-hidden', !showing)
        }

        // --- Supabase realtime + eski mesajlarÄ± yÃ¼kle ---
        // (EÄŸer Supabase baÄŸlantÄ±sÄ±nÄ± kullanmak istemezsen bu bloÄŸu kaldÄ±rabilirsin)
        try {
            supabase.channel('messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, (payload) => {
                    addMessage(payload.new.username, payload.new.message, payload.new.created_at, true)
                    if (payload.new.username !== (nameInput.value || 'Misafir')) sound.play()
                })
                .subscribe()
        } catch (e) {
            // baÄŸlantÄ± yoksa sessizce geÃ§
            console.warn('Realtime baÄŸlanamadÄ±:', e)
        }

        async function loadMessages() {
            try {
                const { data } = await supabase.from('messages').select().order('created_at', { ascending: true })
                if (data) data.forEach(m => addMessage(m.username, m.message, m.created_at, false))
            } catch (e) {
                console.warn('Mesajlar yÃ¼klenemedi:', e)
            }
        }

        function addMessage(username, text, time, playSound = false) {
            const timeStr = time ? new Date(time).toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'}) : new Date().toLocaleTimeString('tr-TR', {hour: '2-digit', minute:'2-digit'})
            const isYou = username === (nameInput.value || 'Misafir')
            const div = document.createElement('div')
            div.className = `message ${isYou ? 'you' : 'other'}`
            div.innerHTML = `<strong>${escapeHtml(username)}</strong><br>${escapeHtml(text).replace(/\n/g, '<br>')}<small>${timeStr}</small>`
            messagesDiv.appendChild(div)
            messagesDiv.scrollTop = messagesDiv.scrollHeight
            if (playSound && !isYou) sound.play()
        }

        // Basit XSS korumasÄ±
        function escapeHtml(str){
            return String(str)
                .replaceAll('&','&amp;')
                .replaceAll('<','&lt;')
                .replaceAll('>','&gt;')
                .replaceAll('"','&quot;')
                .replaceAll("'","&#039;");
        }

        window.send = async () => {
            let text = msgInput.value.trim()
            if (!text) return
            let username = nameInput.value.trim() || 'Misafir'
            localStorage.setItem('chatName', username)

            try {
                await supabase.from('messages').insert({ username, message: text })
            } catch (e) {
                // EÄŸer ekleme baÅŸarÄ±sÄ±z ise yerel olarak gÃ¶ster (offline fallback)
                console.warn('Mesaj gÃ¶nderilemedi, yerelde gÃ¶steriliyor.', e)
                addMessage(username, text, new Date().toISOString(), false)
            }
            msgInput.value = ''
            emojiPicker.classList.remove('show')
        }

        msgInput.addEventListener('keypress', e => { if (e.key === 'Enter') send() })
        loadMessages()

        // Tema deÄŸiÅŸtirme fonksiyonu
        function changeTheme(value){
            if (value === 'default') {
                document.body.className = ''
            } else {
                document.body.className = 'theme-' + value
            }
        }

        // -------- Radyo Ã§alar --------
        const radioPlayer = document.getElementById('radioPlayer')
        const stationSelect = document.getElementById('stationSelect')
        const radioStatus = document.getElementById('radioStatus')

        function changeStation(url){
            if (!url) {
                radioPlayer.pause()
                radioPlayer.src = ''
                radioStatus.textContent = 'Duruyor'
                return
            }
            radioPlayer.src = url
            radioPlayer.play().then(() => {
                radioStatus.textContent = 'Ã‡alÄ±yor'
            }).catch(err => {
                radioStatus.textContent = 'Ã‡alma hatasÄ±'
                console.warn('Radyo Ã§alma hatasÄ±:', err)
            })
        }

        function toggleRadio(){
            if (!radioPlayer.src) {
                // eÄŸer seÃ§ili yoksa seÃ§iliyi al
                const val = stationSelect.value
                if (!val) {
                    radioStatus.textContent = 'Radyo URL seÃ§in'
                    return
                }
                changeStation(val)
                return
            }
            if (radioPlayer.paused) {
                radioPlayer.play().then(()=> radioStatus.textContent = 'Ã‡alÄ±yor').catch(()=> radioStatus.textContent = 'Ã‡alma hatasÄ±')
            } else {
                radioPlayer.pause()
                radioStatus.textContent = 'Durdu'
            }
        }

        // EÄŸer kullanÄ±cÄ± kendi URL'sini yapÄ±ÅŸtÄ±rmak isterse select'e yapÄ±ÅŸtÄ±rÄ±p onchange ile Ã§aÄŸÄ±rabilir.
        // Ã–rnek: stationSelect.value = 'https://senin-stream-url.m3u' ; changeStation(stationSelect.value)

    </script>
</body>
</html>
